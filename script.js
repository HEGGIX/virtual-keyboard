const config = [
    [
        {
            keyCode: 192,
            lang: {
                ru: '~',
                en: '`'
            },
            type: 'letter'
        },
        {
            keyCode: 49,
            lang: {
                ru: '1',
                en: '1'
            },
            type: 'letter'
        },
        {
            keyCode: 50,
            lang: {
                ru: '2',
                en: '2'
            },
            type: 'letter'
        },
        {
            keyCode: 51,
            lang: {
                ru: '3',
                en: '3'
            },
            type: 'letter'
        },
        {
            keyCode: 52,
            lang: {
                ru: '4',
                en: '4'
            },
            type: 'letter'
        },
        {
            keyCode: 53,
            lang: {
                ru: '5',
                en: '5'
            },
            type: 'letter'
        },
        {
            keyCode: 54,
            lang: {
                ru: '6',
                en: '6'
            },
            type: 'letter'
        },
        {
            keyCode: 55,
            lang: {
                ru: '7',
                en: '7'
            },
            type: 'letter'
        },
        {
            keyCode: 56,
            lang: {
                ru: '8',
                en: '8'
            },
            type: 'letter'
        },
        {
            keyCode: 57,
            lang: {
                ru: '9',
                en: '9'
            },
            type: 'letter'
        },
        {
            keyCode: 58,
            lang: {
                ru: '0',
                en: '0'
            },
            type: 'letter'
        },
        {
            keyCode: 189,
            lang: {
                ru: '-',
                en: '-'
            },
            type: 'letter'
        },
        {
            keyCode: 187,
            lang: {
                en: '=',
                ru: '='
            },
            type: 'letter'
        },
        {
            keyCode: 8,
            lang: {
                en: 'Backspace',
                ru: 'Backspace'
            },
            style: 'backspace',
            type: 'backspace'
        }
    ],
    [
        {
            keyCode: 9,
            lang: {
                en: 'Tab',
                ru: 'Tab'
            },
            style: "special"
        },
        {
            keyCode: 81,
            lang: {
                en: 'q',
                ru: 'й',
            },
            type: 'letter'
        },
        {
            keyCode: 87,
            lang: {
                en: 'w',
                ru: 'ц'
            },
            type: 'letter'
        },
        {
            keyCode: 69,
            lang: {
                en: 'e',
                ru: 'у'
            },
            type: 'letter'
        },
        {
            keyCode: 82,
            lang: {
                en: 'r',
                ru: 'к'
            },
            type: 'letter'
        },
        {
            keyCode: 84,
            lang: {
                en: 't',
                ru: 'е'
            },
            type: 'letter'
        },
        {
            keyCode: 89,
            lang: {
                en: 'y',
                ru: 'н'
            },
            type: 'letter'
        },
        {
            keyCode: 85,
            lang: {
                en: 'u',
                ru: 'г'
            },
            type: 'letter'
        },
        {
            keyCode: 73,
            lang: {
                en: 'i',
                ru: 'ш'
            },
            type: 'letter'
        },
        {
            keyCode: 79,
            lang: {
                en: 'o',
                ru: 'щ'
            },
            type: 'letter'
        },
        {
            keyCode: 80,
            lang: {
                en: 'p',
                ru: 'з'
            },
            type: 'letter'
        },
        {
            keyCode: 219,
            lang: {
                en: '[',
                ru: 'х'
            },
            type: 'letter'
        },
        {
            keyCode: 221,
            lang: {
                en: ']',
                ru: 'ъ'
            },
            type: 'letter'
        },
        {
            keyCode: 220,
            lang: {
                en: '\\',
                ru: '\\'
            }
        },
        {
            keyCode: 46,
            lang: {
                en: 'Del',
                ru: 'Del'
            },
            style: "special",
            type: "delete"
        },
    ],
    [
        {
            keyCode: 20,
            lang: {
                en: 'CapsLock',
                ru: 'CapsLock'
            },
            style: 'capslock',
            type: 'capslock'
        },
        {
            keyCode: 65,
            lang: {
                en: 'a',
                ru: 'ф'
            },
            type: 'letter'
        },
        {
            keyCode: 83,
            lang: {
                en: 's',
                ru: 'ы'
            },
            type: 'letter'
        },
        {
            keyCode: 68,
            lang: {
                en: 'd',
                ru: 'в'
            },
            type: 'letter'
        },
        {
            keyCode: 70,
            lang: {
                en: 'f',
                ru: 'а'
            },
            type: 'letter'
        },
        {
            keyCode: 71,
            lang: {
                en: 'g',
                ru: 'п'
            },
            type: 'letter'
        },
        {
            keyCode: 72,
            lang: {
                en: 'h',
                ru: 'р'
            },
            type: 'letter'
        },
        {
            keyCode: 74,
            lang: {
                en: 'j',
                ru: 'о'
            },
            type: 'letter'
        },
        {
            keyCode: 75,
            lang: {
                en: 'k',
                ru: 'л'
            },
            type: 'letter'
        },
        {
            keyCode: 76,
            lang: {
                en: 'l',
                ru: 'д'
            },
            type: 'letter'
        },
        {
            keyCode: 186,
            lang: {
                en: ';',
                ru: 'ж'
            },
            type: 'letter'
        },
        {
            keyCode: 222,
            lang: {
                en: '\'',
                ru: 'э'
            },
            type: 'letter'
        },
        {
            keyCode: 13,
            lang: {
                en: 'Enter',
                ru: 'Enter'
            },
            style: 'enter',
            type: 'enter'
        }
    ],
    [
        {
            keyCode: 16,
            lang: {
                en: 'Shift',
                ru: 'Shift'
            },
            style: 'shift',
            type: 'shift'
        },
        {
            keyCode: 90,
            lang: {
                en: 'z',
                ru: 'я'
            },
            type: 'letter'
        },
        {
            keyCode: 88,
            lang: {
                en: 'x',
                ru: 'ч'
            },
            type: 'letter'
        },
        {
            keyCode: 67,
            lang: {
                en: 'c',
                ru: 'с'
            },
            type: 'letter'
        },
        {
            keyCode: 86,
            lang: {
                en: 'v',
                ru: 'м'
            },
            type: 'letter'
        },
        {
            keyCode: 66,
            lang: {
                en: 'b',
                ru: 'и'
            },
            type: 'letter'
        },
        {
            keyCode: 78,
            lang: {
                en: 'n',
                ru: 'т'
            },
            type: 'letter'
        },
        {
            keyCode: 77,
            lang: {
                en: 'm',
                ru: 'ь'
            },
            type: 'letter'
        },
        {
            keyCode: 188,
            lang: {
                en: ',',
                ru: 'б'
            },
        },
        {
            keyCode: 190,
            lang: {
                en: '.',
                ru: 'ю'
            },
            type: 'letter'
        },
        {
            keyCode: 191,
            lang: {
                en: '/',
                ru: '.'
            },
        },
        {
            keyCode: 38,
            lang: {
                en: 'Up',
                ru: 'Up'
            },
            style: "special"
        },
        {
            keyCode: 16,
            lang: {
                en: 'Shift',
                ru: 'Shift'
            },
            style: 'shift'
        },
    ],
    [
        {
            keyCode: 17,
            lang: {
                en: 'Ctrl',
                ru: 'Ctrl'
            },
            style: "special"
        },
        {
            keyCode: 91,
            lang: {
                en: 'Win',
                ru: 'Win'
            },
            style: "special"
        },
        {
            keyCode: 18,
            lang: {
                en: 'Alt',
                ru: 'Alt'
            },
            style: "special"
        },
        {
            keyCode: 32,
            lang: {
                en: '',
                ru: ''
            },
            style: "space",
            type: 'space'
        },
        {
            keyCode: 18,
            lang: {
                en: 'Alt',
                ru: 'Alt'
            },
            style: "special"
        },
        {
            keyCode: 37,
            lang: {
                en: 'Left',
                ru: 'Left'
            },
            style: "special"
        },
        {
            keyCode: 40,
            lang: {
                en: 'Down',
                ru: 'Down'
            },
            style: "special"
        },
        {
            keyCode: 39,
            lang: {
                en: 'Right',
                ru: 'Right'
            },
            style: "special"
        },
        {
            keyCode: 17,
            lang: {
                en: 'Ctrl',
                ru: 'Ctrl'
            },
            style: "special"
        }
    ]
]

const container = document.createElement('div');
const textarea = document.getElementById('textarea');
const languages = ['en', 'ru'];
let isCapsLock = false;
let language = 'en';
let isShift = false;
document.body.appendChild(container);
container.classList.add('container');

let callbackList = [

]

function init() {
    config.forEach(row => {
        const rowDiv = document.createElement('div');
        container.appendChild(rowDiv);
        rowDiv.classList.add('row');
        row.forEach(key => {
            const div = document.createElement('div');
            div.dataset.key = key.keyCode;
            div.dataset.keyType = key.type ? key.type : 'none';
            div.dataset.enKey = key.lang.en;
            div.dataset.ruKey = key.lang.ru;
            div.innerHTML = key.lang.en;
            div.classList.add('key');
            const style = key.style ? key.style : 'common';
            div.classList.add(style);
            rowDiv.appendChild(div);
            console.log(div.dataset.keyType);
            div.addEventListener('mousedown', () => mousedown(div));
            div.addEventListener('mouseup', () => mouseup(div));
            div.addEventListener('mouseout', () => div.classList.remove('pressed'));
        })
    })
}

init();

window.addEventListener('keydown', (event) => {
    const keyCode = event.keyCode.toString();
    const key = document.querySelector(`[data-key="${keyCode}"]`);
    if (!key) return;

    key.classList.add('pressed');

})

window.addEventListener('keyup', (event) => {
    const keyCode = event.keyCode.toString();
    const key = document.querySelector(`[data-key="${keyCode}"]`);
    if (!key) return;

    key.classList.remove('pressed');
})

function mousedown(key) {
    key.classList.add('pressed');
}

function mouseup(key) {
    key.classList.remove('pressed');
    parseKey(key);
}

function parseKey(key) {
    if (key.dataset.keyType === 'letter') {
        let value = getKeyByLanguage(key)
        value = isCapsLock ? value.toUpperCase() : value.toLowerCase();
        insertTextAtCursor(textarea, value);
    } else if (key.dataset.keyType === 'space') {
        insertTextAtCursor(textarea, ' ');
    } else if (key.dataset.keyType === 'enter') {
        insertTextAtCursor(textarea, '\n');
    } else if (key.dataset.keyType === 'backspace') {
        const selectionStart = textarea.selectionStart;
        if (selectionStart === 0) return;
        textarea.value = deleteLastSymbol(textarea.value);
        textarea.focus();
        textarea.selectionStart = selectionStart - 1;
        textarea.selectionEnd = selectionStart - 1;
    } else if (key.dataset.keyType === 'capslock') {
        setCapsLock();
        setCaseToKeys();
    } else if (key.dataset.keyType === 'delete') {
        const selectionStart = textarea.selectionStart;
        textarea.value = deletePrevSymbol(textarea.value);
        textarea.focus();
        textarea.selectionStart = selectionStart;
        textarea.selectionEnd = selectionStart;
    }
}

function setCapsLock() {
    isCapsLock = !isCapsLock;
}

function insertTextAtCursor(element, text) {
    element.focus();
    const startPos = element.selectionStart;
    const endPos = element.selectionEnd;
    element.value =
        element.value.substring(0, startPos) +
        text +
        element.value.substring(endPos, element.value.length);
    element.selectionStart = element.selectionEnd = startPos + text.length;
}

function getKeyByLanguage(key) {
    return key.dataset[`${language}Key`];
}

document.addEventListener('keydown', (event) => {
    if (event.ctrlKey && event.altKey) setLanguage();
})

function setLanguage() {
    const index = languages.indexOf(language) === 0 ? 1 : 0;
    language = languages[index];
    console.log(language);
    changeKeyByLang();
    setCaseToKeys();
}

function changeKeyByLang() {
    const allKeys = Array.from(document.querySelectorAll('.key'));
    allKeys.forEach(key => {
        key.innerHTML = key.dataset[`${language}Key`];
    })
}

function deleteLastSymbol(text) {
    return text.slice(0, textarea.selectionStart - 1) + text.slice(textarea.selectionStart);
}

function deletePrevSymbol(text) {
    return text.slice(0, textarea.selectionStart) + text.slice(textarea.selectionStart + 1);
}

function setCaseToKeys() {
    const allKeys = Array.from(document.querySelectorAll('.key'));
    allKeys.forEach(key => {
        if (key.dataset.keyType === 'letter') {
            key.innerHTML = isCapsLock ? key.innerHTML.toUpperCase() : key.innerHTML.toLowerCase();
        }
    })
}

textarea.addEventListener('keypress', () => console.log('keypress'));
textarea.addEventListener('change', () => console.log('change'));




